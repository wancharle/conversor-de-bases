<!DOCTYPE html>
<HTML>
<head>
    <title>Conversor de bases</title>
    <meta charset="UTF-8"/>
    <script src="d3/d3.min.js"></script>
    <script src="d3/d3-selection-multi.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
 
    <style>
      #converteDecimal td {border: 1px solid white;1px;width:60px; text-align: center;}
      .casa-simbolo {background-color: blue; color: white;}
      .casa-valor {background-color:rgb(207,216,232)}
      .casa-conta {background-color: rgb(233,237,255)}
    </style>
</head>
<body onload="calcula()">
    <section class="hero is-info">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              Conversor de bases numéricas
            </h1>
            <h2 class="subtitle">
              Esta pagina fornece alguns recursos automáticos para conversão entre bases numéricas
            </h2>
          </div>
        </div>
      </section>

    <section class="section">
        <div class="container">
          <h1 class="title">Conversão para base decimal</h1>
          <div class="content">
          <p>Informe o número e a base do número para realizar a conversão para base decimal:</p>
                <div class="field has-addons">

                    <p class="control"><input placeholder="número" class="input" value="" type="text" text="543" id="inputNumero" onkeyup="atualiza()" onchange="limpa();calcula()"></p>

                    <p class="control"><span class="select"><select id="inputBase" onchange="limpa();calcula();">
                    <option value="10">base decimal</option>
                    <option value="2">base binária</option>
                    <option value="8">base octal</option>
                    <option value="16">base hexadecimal</option>
                  </select></span></p>
                  <p id="simbs"></p>
                </div>

        <p class="hide">Convertendo <span id="legenda"></span> para base decimal temos que o resultado é: </p>
        <p class="hide" id="somacasas"></p>
 
        <p class="hide">Observe o quadro abaixo para entender como foi feito a conversão:</p>
        <table id="converteDecimal">
          <tr class="casa-simbolo"> </tr>
          <tr class="casa-conta"> </tr>
          <tr class="casa-valor"> </tr>
        </table>
       </div> <!-- fim content -->
        </div>
      </section>

      <footer class="footer">
          <div class="container">
            <div class="content has-text-centered">
              <p>
                <strong>Conversor de Bases</strong> construído por <a href="https://github.com/wancharle">Wancharle S. Quirino</a>.
              </p>
            </div>
          </div>
        </footer>
<script>
// http://blog.techhysahil.com/svg/how-to-center-text-in-svg-shapes/
// http://www.d3noob.org/2014/02/attributes-in-d3js.html
var SIMBOLOS = "0123456789ABCDEF"

function  limpa(){
  d3.select("tr.casa-simbolo").selectAll("td").data([],function(d){return d}).exit().remove()
  d3.select("tr.casa-valor").selectAll("td").data([],function(d){return d}).exit().remove()
  d3.select("tr.casa-conta").selectAll("td").data([],function(d){return d}).exit().remove()
}                                    

function atualiza(){
    
    legenda.innerHTML = inputNumero.value+" na base "+inputBase.value
    limpa();calcula();
    }
function algarismoForaDaBase(algarismo,base){
    var ind;
    ind = SIMBOLOS.indexOf(algarismo) + 1
    return (ind == 0) || (ind  > base)
}
function check(numero,base){
    
    for (i=0;i<numero.length;i++){
        if (algarismoForaDaBase(numero[i],base)){
            inputNumero.value = ""
            return ""
        }
    }
    return numero 
}

function calcula(data,base){
  base = inputBase.value
  data = inputNumero.value.toUpperCase();
  data = check(data,base)
  simbs.innerHTML = "<span style='margin-left:20px'>Algarismos: "+ SIMBOLOS.slice(0,base).split("").join(", ")+"</span>";

  if (data == ""){
    d3.selectAll("p.hide").style("visibility","hidden");     
    return
  }else{
    d3.selectAll("p.hide").style("visibility","visible");     
      }
  var valor = 0;
  d3.select("tr.casa-simbolo").selectAll("td").data(data,function(d){return d})
      .enter().append('td').text(function(d,i) { return d  })

  d3.select("tr.casa-valor").selectAll("td").data(data,function(d){return d})
      .enter().append('td').text(function(d,i) { 
          var valorCasa = calculaValorCasa(d,base,data.length - i -1)
          valor = valor + valorCasa;
          return valorCasa
        })

  d3.select("tr.casa-conta").selectAll("td").data(data,function(d){return d})
      .enter().append('td').html(function(d,i){ 
        var posicao;
        posicao = data.length - i - 1;
        return "<math><mn>"+d+"</mn><mo>*</mo><msup><mn>"+base+"</mn><mn>"+posicao+"</mn></msup></math>"
      });   


var texto = "<math><msub><mn>"+data+"</mn><mn>"+base+"</mn></math> = "
  texto += data.split('').map(function(n,i,ar){ return calculaValorCasa(n,base,ar.length - i -1) }).join(' + ')
  texto += " = <math><msub><mn>"+valor+"</mn><mn>"+10+"</mn></math>"
  texto += "<br/><br/> Ou seja, "+data+" em base " + base + " é igual a " + valor + " em base decimal"
  somacasas.innerHTML = texto 
}

function calculaValorCasa(simbolo, base, posicao){
    var valorSimbolo = SIMBOLOS.indexOf(simbolo.toUpperCase())
    return valorSimbolo*(base**posicao)
}

// TODO: adicionar conversao de decimal para binario
// TODO: bloquear conversão com simbolos fora do intervalo da base (exemplos: numeros maior que 1 em base binaria, > 7 em octal, > 15 em hexa)
// TODO: adicionar suporte a mudança entre bases usando logarítimo
// TODO: adicionar soma binária
// TODO: adicionar subtração binária
// TODO: adicionar multiplicação binária
// TODO: adicionar divisão (tanto binária como decimal)
</script>  
</body>
</HTML>
